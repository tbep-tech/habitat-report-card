---
title: "Habitat Updates"
author: "Tampa Bay Estuary Program"
date: "`r Sys.Date()`"
format:
  html:
    theme: cosmo
    code-tools: 
      source: https://github.com/tbep-tech/habitat-report-card/blob/master/docs/oysterthresh.qmd
    css: styles.css
    embed-resources: true
toc: true
lightbox: true
execute:
  echo: false
  warning: false
---

```{r}
#| include: false
library(tidyverse)
library(forcats)
library(foreign)
library(reactable)
library(here)
library(networkD3)
library(reactablefmtr)
library(highcharter)

# source functions and data from https://github.com/tbep-tech/landuse-change
source('https://github.com/tbep-tech/landuse-change/raw/refs/heads/master/R/funcs.R')

load(file = url('https://github.com/tbep-tech/landuse-change/raw/refs/heads/master/data/acres.RData'))
load(file = url('https://github.com/tbep-tech/landuse-change/raw/refs/heads/master/data/subtacres.RData'))
load(file = url('https://github.com/tbep-tech/landuse-change/raw/refs/heads/master/data/chgdat.RData'))
load(file = url('https://github.com/tbep-tech/landuse-change/raw/refs/heads/master/data/subtchgdat.RData'))
load(file = url('https://github.com/tbep-tech/landuse-change/raw/refs/heads/master/data/fluccs.RData'))

lucats <- c('Mangrove Forests', 'Salt Barrens', 'Salt Marshes', 'Coastal Uplands', 'Non-Forested Freshwater Wetlands', 'Forested Freshwater Wetlands', 'Native Uplands')
sbcats <- c('Tidal Flats', 'Seagrasses', 'Oyster Bars')
```

This short summary provides an update on habitats in Tampa Bay and its watershed using the most recent data available.  These data include 2024 subtidal data and 2023 land use/cover data (intertidal/supratidal) from the Southwest Florida Water Management District (SWFWMD).  The goal is to describe the most recent status and trends to facilitate a discussion on identifying priorities for the Habitat Restoration Consortium (HRC). 

Habitat strata terms:

* **Subtidal**: Submerged all or most of the time - tidal flats, seagrasses, oyster bars
* **Intertidal**: Emergent tidal wetlands submerged during high tides but exposed during low tides - mangrove forests, salt barrens, salt marshes
* **Supratidal**: Occuring above the high tide line - coastal uplands, non-forested freshwater wetlands, forested freshwater wetlands, native uplands

## Habitat Master Plan
 
The plot below is used to summarize status and trends of key habitats with prescribed short-term (2030) targets in acreage coverage defined in the TBEP [Habitat Master Plan](https://drive.google.com/file/d/1Hp0l_qtbxp1JxKJoGatdyuANSzQrpL0I/view).  The plot shows current progress in achieving these targets, dividing the habitats into subtidal, intertidal, and supratidal strata.  Colors denote whether a target is achieved (green) or not achieved (red) for a given year of data and the arrows indicate whether the target is expected to be met (up) or not expected to be met (down) by 2030 based on the linear trend between year pairs. Note that the report card does not indicate an absolute decrease or increase between year pairs (e.g., the trend may suggest a target will not be met with a down arrow even if a gain in acreage between year pairs occurred).

![](figs/hmpreport.png)

A table showing the numeric targets (goals) and current acreage relative to the targets (goals) for each habitat type can be viewed [here](tabs/target_table_simple_no_total_intertidal.png). 

## Summary of land use and subtidal changes

The tables below show the absolute changes in acreage from the most current year of data with the previous. Red denotes a loss and green denotes a gain.

::: {.panel-tabset .nav-pills}

## Subtidal

```{r}
subtacres |> 
    filter(name %in% c(2022, 2024)) |> 
    filter(HMPU_TARGETS %in% sbcats) |>
    lngtrmtab_fun('Category', yrsel = c('2022', '2024'))
```

## Intertidal and supratidal

```{r}
acres |> 
    filter(name %in% c(2020, 2023)) |> 
    filter(HMPU_TARGETS %in% lucats) |> 
    lngtrmtab_fun('Category', yrsel = c('2020', '2023'))
```

:::

## Changes by habitat

The plots below show all years of data for each habitat type, with bars colored when an decrease (red) or increase (green) was observed from the previous year.

::: {.panel-tabset .nav-pills}

```{r}
create_barplot <- function(target_data, target_name) {
  
  target_data <- target_data |> 
    ungroup() |> 
    filter(HMPU_TARGETS == !!target_name) |> 
    mutate(
        chgv = sign(c(NA, diff(Acres))), 
        chgv = factor(chgv, levels = c(-1, 0, 1), labels = c('dec', 'no change', 'inc')),
    )

  # Define colors based on change direction
  colors <- ifelse(is.na(target_data$chgv), "#95a5a6",  # gray for NA
                  ifelse(target_data$chgv == "inc", "#27ae60",  # green for increase
                         "#e74c3c"))  # red for decrease
  
  hc <- highchart() |>
    hc_chart(type = "column") |>
    highcharter::hc_add_theme(
      highcharter::hc_theme(chart = list(backgroundColor = 'white'))
    ) |> 
    hc_title(text = target_name) |>
    hc_xAxis(categories = target_data$name) |>
    hc_yAxis(title = list(text = "Acres")) |>
    hc_add_series(
      data = target_data$Acres,
      name = "Acres",
      colorByPoint = TRUE,
      colors = colors
    ) |>
    hc_tooltip(
      pointFormat = "<b>{point.y:,.0f}</b> acres<br/>",
      headerFormat = "<span style='font-size:10px'>{point.key}</span><br/>"
    ) |>
    hc_plotOptions(
      column = list(
        dataLabels = list(
          enabled = TRUE,
          format = "{y:,.0f}"
        )
      )
    ) |>
    hc_legend(enabled = FALSE) |>
    hc_credits(enabled = FALSE) |> 
    hc_exporting(
      enabled = TRUE,
      filename = "myplot",
      buttons = list(
        contextButton = list(
          menuItems = c("viewFullscreen", "downloadPNG", "downloadCSV")
        )
      )
    )
  
  return(hc)
}
```

## Subtidal

```{r}
#| fig-width: 12
#| fig-height: 4
#| results: asis

plots_list <- map(sbcats, function(sbcat) {
  create_barplot(subtacres, sbcat)
})

plots_list[[1]]
plots_list[[2]]
plots_list[[3]]
```

## Intertidal and Supratidal

```{r}
#| fig-width: 12
#| fig-height: 4
#| results: asis

plots_list <- map(lucats, function(lucat) {
  create_barplot(acres, lucat)
})

plots_list[[1]]
plots_list[[2]]
plots_list[[3]]
plots_list[[4]]
plots_list[[5]]
plots_list[[6]]
plots_list[[7]]
```

:::

## Summary

The 2024 [habitat report card](https://drive.google.com/file/d/1yrq8M5CA_LqM0DRqmtYY1IJDjD4VJY2l/view) identified seagrasses, salt marsh, and forested freshwater wetlands as priority habitats for restoration and conservation efforts based on trends from the prior year's data.  Following the current data updates, priorities are more difficult to identify. Using only the information above, the following conclusions can be made.  Potential priorities are those where the target is not likely to be met and the coverage is currently below the target.

* **Tidal Flats**: Likely to meet target, currently above target.
* **Seagrasses**: Not likely to meet target, currently below target, but saw an increase in acreage in 2024. **Priority?**
* **Oyster Bars**: Not likely to meet target, currently below target following decline from previously mapping cycle. **Priority?**
* **Mangrove Forests**: Not likely to meet target, currently above target.
* **Salt Barrens**: Likely to meet taget, currently above target.
* **Salt Marshes**: Not likely to meet target, currently below target. **Priority?**
* **Coastal Uplands**: Not likely to meet target, currently below target. **Priority?**
* **Non-Forested Freshwater Wetlands**: Likely to meet target, currently above target.
* **Forested Freshwater Wetlands**: Not likely to meet target, currently below target. **Priority?**
* **Native Uplands**: Not likely to meet target, currently below target. **Priority?**