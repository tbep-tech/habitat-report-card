---
title: "Habitat Report Card Updates"
author: "Tampa Bay Estuary Program"
date: "`r Sys.Date()`"
format:
  html:
    theme: cosmo
    code-tools: 
      source: https://github.com/tbep-tech/habitat-report-card/blob/master/docs/oysterthresh.qmd
    css: styles.css
    embed-resources: true
toc: true
lightbox: true
execute:
  echo: false
  warning: false
---

```{r}
#| include: false
library(tidyverse)
library(forcats)
library(foreign)
library(reactable)
library(here)
library(networkD3)
library(reactablefmtr)
library(highcharter)

# source functions and data from https://github.com/tbep-tech/landuse-change
source('https://github.com/tbep-tech/landuse-change/raw/refs/heads/master/R/funcs.R')

load(file = url('https://github.com/tbep-tech/landuse-change/raw/refs/heads/master/data/acres.RData'))
load(file = url('https://github.com/tbep-tech/landuse-change/raw/refs/heads/master/data/subtacres.RData'))
load(file = url('https://github.com/tbep-tech/landuse-change/raw/refs/heads/master/data/chgdat.RData'))
load(file = url('https://github.com/tbep-tech/landuse-change/raw/refs/heads/master/data/subtchgdat.RData'))
load(file = url('https://github.com/tbep-tech/landuse-change/raw/refs/heads/master/data/fluccs.RData'))

lucats <- c('Mangrove Forests', 'Salt Barrens', 'Salt Marshes', 'Coastal Uplands', 'Non-Forested Freshwater Wetlands', 'Forested Freshwater Wetlands', 'Native Uplands')
sbcats <- c('Tidal Flats', 'Seagrasses', 'Oyster Bars')
```

This short summary provides an update on habitats in Tampa Bay and its watershed using the msot recent data available.  These data include 2024 subtidal data and 2023 land use/cover data from the Southwest Florida Water Management Distric (SWFWMD).  The goal is to describe the most recent status and trends to facilitate a discussion on identifying priorities for the Habitat Restoration Consortium (HRC). 

## Habitat Report Card
 
The habitat report card is used to summarize status and trends of key habitats with prescribed short-term (2030) targets and long-term (2050) goals in acreage coverage.  Below shows the current report card and progress in achieving short-term targets, dividing the habitats into subtidal, intertidal, and supratidal strata.  Colors denote whether a target is achieved (green) or not achieved (red) for a given year of data and the arrows indicating whether the target is expected to be met (up) or not expected to be met (down) based on the linear trend between year pairs. Note that it does not indicate a decrease or increase between year pairs (e.g., the trend may still suggest a target will not be met with a down arrow even if a gain in acreage between year pairs occurred).

![](figs/hmpreport.png)

## Summary of land use and subtidal changes

The tables below show the absolute changes in acreage from the most current year of data with the previous. Red denotes a loss and green denotes a gain.

### Subtidal

```{r}
subtacres |> 
    filter(name %in% c(2022, 2024)) |> 
    filter(HMPU_TARGETS %in% sbcats) |>
    lngtrmtab_fun('Category', yrsel = c('2022', '2024'))
```

### Intertidal and supratidal

```{r}
acres |> 
    filter(name %in% c(2020, 2023)) |> 
    filter(HMPU_TARGETS %in% lucats) |> 
    lngtrmtab_fun('Category', yrsel = c('2020', '2023'))
```

## Changes by habitat

The plots below show all years of data, with bars colored where an increase (green) or decrease (red) was observed from the previous year.

```{r}
create_barplot <- function(target_data, target_name) {
  
  target_data <- target_data |> 
    ungroup() |> 
    filter(HMPU_TARGETS == !!target_name) |> 
    mutate(
        chgv = sign(c(NA, diff(Acres))), 
        chgv = factor(chgv, levels = c(-1, 0, 1), labels = c('dec', 'no change', 'inc')),
    )

  # Define colors based on change direction
  colors <- ifelse(is.na(target_data$chgv), "#95a5a6",  # gray for NA
                  ifelse(target_data$chgv == "inc", "#27ae60",  # green for increase
                         "#e74c3c"))  # red for decrease
  
  hc <- highchart() |>
    hc_chart(type = "column") |>
    hc_title(text = target_name) |>
    hc_xAxis(categories = target_data$name) |>
    hc_yAxis(title = list(text = "Acres")) |>
    hc_add_series(
      data = target_data$Acres,
      name = "Acres",
      colorByPoint = TRUE,
      colors = colors
    ) |>
    hc_tooltip(
      pointFormat = "<b>{point.y:,.0f}</b> acres<br/>",
      headerFormat = "<span style='font-size:10px'>{point.key}</span><br/>"
    ) |>
    hc_plotOptions(
      column = list(
        dataLabels = list(
          enabled = TRUE,
          format = "{y:,.0f}"
        )
      )
    ) |>
    hc_legend(enabled = FALSE) |>
    hc_credits(enabled = FALSE)
  
  return(hc)
}
```

### Subtidal

```{r}
#| fig-width: 12
#| fig-height: 4
#| results: asis

plots_list <- map(sbcats, function(sbcat) {
  create_barplot(subtacres, sbcat)
})

plots_list[[1]]
plots_list[[2]]
plots_list[[3]]
```

### Intertidal and Supratidal

```{r}
#| fig-width: 12
#| fig-height: 4
#| results: asis

plots_list <- map(lucats, function(lucat) {
  create_barplot(acres, lucat)
})

plots_list[[1]]
plots_list[[2]]
plots_list[[3]]
plots_list[[4]]
plots_list[[5]]
plots_list[[6]]
plots_list[[7]]
```
