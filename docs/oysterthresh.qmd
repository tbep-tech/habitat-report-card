---
title: "Oyster Bay Segment Tresholds"
author: "Tampa Bay Estuary Program"
date: "`r Sys.Date()`"
format:
  html:
    theme: cosmo
    code-tools: 
      source: https://github.com/tbep-tech/habitat-report-card/blob/master/docs/oysterthresh.qmd
    css: styles.css
toc: true
lightbox: true
execute:
  echo: false
  warning: false
---

```{r}
#| include: false
library(sf)
library(tidyverse)
library(here)
library(reactable)
library(reactablefmtr)
library(leaflet)

source(here('R/funcs.R'))

load(file = here('data/oysterhsi.RData'))
load(file = here('data/oysdat.RData'))
load(file = here('data/oysunion.RData'))
load(file = here('data/oydat2024.RData'))
load(file = here('data/oydat2022.RData'))
load(file = here('data/swfwmdtbsegcor.RData'))

goal <- 471

levs <- c('Old Tampa Bay', 'Hillsborough Bay', 'Middle Tampa Bay',
          'Lower Tampa Bay', 'Boca Ciega Bay', 'Terra Ceia Bay', 'Manatee River')

toint <- swfwmdtbsegcor |> 
  st_transform(st_crs(oysterhsi))

oydat <- oysterhsi |> 
  select(
    osi = OSI_VALUE
  ) |> 
  filter(osi %in% c(14, 15)) |> 
  st_intersection(toint) |>
  mutate(
    acres = as.numeric(units::set_units(st_area(Shape), 'acre'))
  ) 
```

Oyster acreage thresholds are based on the Habitat Master Plan goal of 471 acres by 2050, where the total goal is divided among the seven bay segments.  Two options are provided. 

## Option 1: Proportional to OHSI

Option 1 defines potential thresholds for the seven bay segments using the Oyster Habitat Suitability Index (OHSI). OHSI categories 14 and 15 are considered ideal restoration potential for oysters and thresholds are based on the relative proportion of acres in each bay segment, where the sum is 471 acres. Potential thresholds are based on proportions of OHSI categories as 14 and 15 or only category 15 (top priority).  This option assumes that restoration should be focused on areas with the highest OHSI categories or restoration potential, rather than areas where oysters have been present in the past.

```{r}
#| fig-cap: "Graphical Summary of Oyster Habitat Suitability Index (OSI) 14 and 15 Acreage by Bay Segment"
#| fig-width: 7
#| fig-height: 4

toplo <- oydat |> 
  st_set_geometry(NULL) |> 
  summarise(
    acres = sum(acres, na.rm = TRUE),
    .by = c('osi', 'segment')
  ) |> 
  mutate(
    segment = factor(segment, levels = rev(levs)), 
    osi = factor(osi, levels = c('15', '14'))
  )

ggplot(toplo, aes(x = acres / 1000, y = segment, fill = osi)) +
  geom_col(position = 'stack', alpha = 0.85) +
  scale_fill_manual(values = c('darkblue', 'lightblue')) +
  labs(
    y = NULL,
    x = 'Acres of Suitable Habitat (x1000)',
    fill = 'Oyster Habitat Suitability Index'
  ) +
  guides(fill = guide_legend(reverse = T)) + 
  theme_minimal() +
  theme(
    legend.position = 'top',
    panel.grid.major.y = element_blank()
  )

```

```{r}
totab <- toplo |> 
  pivot_wider(
    names_from = 'osi', 
    values_from = 'acres', 
    values_fill = 0
  ) |> 
  mutate(
    Total = `14` + `15`
  )

reactable(totab, 
          columns = list(
            segment = colDef(name = 'Bay Segment', footer = 'Total'), 
            `14` = colDef(name = 'OHSI 14', footer = function(values) htmltools::tags$b(format(round(sum(values), 0), big.mark = ','))),
            `15` = colDef(name = 'OHSI 15', footer = function(values) htmltools::tags$b(format(round(sum(values), 0), big.mark = ','))),
            Total = colDef(footer = function(values) htmltools::tags$b(format(round(sum(values), 0), big.mark = ',')))
          ),
          defaultColDef = colDef(
            format = colFormat(separators = TRUE, digits = 0), 
            footerStyle = list(fontWeight = 'bold')
          ),
          columnGroups = list(colGroup('Acres', columns = c('14', '15', 'Total'))),
          defaultPageSize = nrow(totab),
          highlight = TRUE,
          striped = TRUE,
          bordered = TRUE,
          showPageSizeOptions = FALSE,
          showSortable = FALSE, 
          resizable = TRUE
  ) |> 
  add_title(
    "Tabular Summary of Oyster Habitat Suitability Index (OHSI) 14 and 15 Acreage by Bay Segment", 
    font_size = 15, 
    font_color = 'grey', 
    font_weight = 'normal'
  )
```

<br>

Thresholds can be defined based on the proportional acreages by bay segment, considering OHSI categories 14 and 15 or only category 15.

```{r}
thrs <- totab |> 
  mutate(
    `14 and 15` = goal * Total / sum(Total), 
    `15 only` = goal * `15` / sum(`15`)
  ) |> 
  select(-`14`, -`15`, -Total)

reactable(thrs, 
          columns = list(
            segment = colDef(name = 'Bay Segment', footer = 'Total'), 
            `14 and 15` = colDef(name = 'OHSI 14 and 15', footer = function(values) htmltools::tags$b(format(round(sum(values), 0), big.mark = ','))),
            `15 only` = colDef(name = 'OHSI 15 only', footer = function(values) htmltools::tags$b(format(round(sum(values), 0), big.mark = ',')))
          ),
          defaultColDef = colDef(
            format = colFormat(separators = TRUE, digits = 0), 
            footerStyle = list(fontWeight = 'bold')
          ),
          columnGroups = list(colGroup('Acres', columns = c('15 only', '14 and 15'))),
          defaultPageSize = nrow(thrs),
          highlight = TRUE,
          striped = TRUE,
          bordered = TRUE,
          showPageSizeOptions = FALSE,
          showSortable = FALSE,
          resizable = TRUE
  ) |> 
  add_title(
    "Potential Oyster Thresholds by Bay Segment based on a 2050 Goal of 471 Acres Set Proportionally by OHSI Categories 14 and 15 or Only Category 15", 
    font_size = 15, 
    font_color = 'grey', 
    font_weight = 'normal'
  )
```

<br>

An assessment of trends in oyster acreage by bay segment relative to the potential thresholds can help identify restoration priorities.

```{r}
#| fig-cap: "Oyster Acres by Bay Segment with OHSI Thresholds"
#| fig-width: 7
#| fig-height: 7

toploop1 <- oysdat |> 
  left_join(thrs, by = 'segment')

ggplot(toploop1, aes(x = yr, y = acres)) + 
  geom_col(alpha = 0.85, fill = '#00806E') + 
  facet_wrap(~segment, ncol = 3) +
  scale_x_continuous(breaks = c(2014, 2016, 2018, 2020, 2022, 2024)) +
  geom_hline(aes(yintercept = `15 only`, linetype = '15 only'), color = 'tomato1', linewidth = 1) +
  geom_hline(aes(yintercept = `14 and 15`, linetype = '14 and 15'), color = 'tomato1', linewidth = 1) +
  scale_linetype_manual(name = 'OHSI Thresholds', values = c('15 only' = 'dashed', '14 and 15' = 'dotted')) +
  theme_minimal() +
  theme(
    legend.position = 'top',
    panel.grid.major.x = element_blank(),
    panel.grid.minor = element_blank()
  ) + 
  labs(
    x = NULL, 
    y = 'Oyster Acres'
  )
```

Lastly, a comparison of current (2024) oyster coverage relative to OHSI categories can also inform restoration priorities. The following provides an assessment of the percentage of oyster coverage currently within high priority OHSI categories relative to coverage that is not. The map below shows current oyster coverage relative to OHSI categories 14 and 15 (note that geometries have been simplified slightly to improve map rendering).

```{r}

oydat2024 <- oydat2024 |> 
  st_transform(crs = 4326)
oydatsimp <- oydat |> 
  st_simplify(dTolerance = 50) |> 
  st_transform(crs = 4326)

# Create color palette for osi values
osi_colors <- colorFactor(
  palette = c('lightblue', 'darkblue'), 
  domain = oydat$osi
)

# Create the leaflet map
leaflet() |>
  # Add CartoDB Positron base layer
  addProviderTiles(providers$CartoDB.Positron) |>
  
  # Add OHSI layer with osi coloring
  addPolygons(
    data = oydatsimp,
    fillColor = ~osi_colors(osi),
    fillOpacity = 0.7,
    color = "transparent",  # No borders for performance
    weight = 0,
    group = "OHSI",
    popup = ~paste0("OSI: ", osi)  # Optional popup
  ) |>
  
  # Add 2024 Oyster Coverage layer
  addPolygons(
    data = oydat2024,
    fillColor = "red",
    fillOpacity = 0.7,
    color = "transparent",  # No borders for performance
    weight = 0,
    group = "Oyster Coverage 2024",
    popup = ~paste0("FLUCC: ", FLUCCSCODE)  # Optional popup
  ) |>
  
  # Add layer controls
  addLayersControl(
    overlayGroups = c("OHSI", "Oyster Coverage 2024"),
    options = layersControlOptions(collapsed = FALSE)
  ) |>
  
  # Add legend for OHSI
  addLegend(
    pal = osi_colors,
    values = oydat$osi,
    title = "OHSI",
    position = "bottomright",
    group = "OHSI"
  ) |>
  
  # Add simple legend for 2024 coverage (manual)
  addLegend(
    colors = "red",
    labels = "Oyster Coverage 2024",
    title = "2024 Coverage",
    position = "bottomright"
  )
```

<br>

The next two plots provide a graphical summary of current (2024) oyster coverage relative to OHSI categories 14 and 15 and oysters in neither OHSI category.  The second plot shows the percentage of the total OHSI categories 14 or 15 that include oysters.

```{r}
#| fig-cap: "Graphical Summary of Oyster Coverage Relative to OHSI Categories 14 and 15"
#| fig-width: 7
#| fig-height: 4

toplo <- oysunion |> 
  st_set_geometry(NULL) |> 
  mutate(
    segment = factor(segment, levels = rev(levs))
  ) |> 
  summarise(
    acres = sum(acres), 
    .by = c(FLUCCSCODE, segment, osi)
  )

toplo1 <- toplo |> 
  select(segment, osi, acres) |> 
  filter(osi %in% c('14', '15')) |> 
  mutate(
    osi = factor(osi, levels = c('15', '14'))
  ) |> 
  summarise(
    acres = sum(acres), 
    .by = c(segment, osi)
  )
toplo2 <- toplo |>
  filter(FLUCCSCODE == 'Oyster') |> 
  select(segment, osi, acres) |> 
  mutate(    
    osi = factor(osi, levels = c('Not 14 or 15', '15', '14'))
  ) |>
  summarise(
    acres = sum(acres), 
    .by = c(segment, osi)
  )

ggplot(toplo2, aes(x = acres, y = segment, fill = osi)) +
  geom_col( position = 'stack', alpha = 0.85) +
  scale_fill_manual(values = c('darkred', 'red', 'lightpink')) + # red scale
  guides(fill = guide_legend(reverse = T)) + 
  theme_minimal() +
  theme(
    legend.position = 'top',
    panel.grid.major.y = element_blank()
  ) + 
  labs(
    fill = 'Oyster Habitat Suitability Index', 
    x = 'Acres',
    y = NULL
  )
```

```{r}
#| fig-cap: "Percentage of Total Oyster Acres by OHSI Category"
#| fig-width: 7
#| fig-height: 4

toplo3 <- inner_join(toplo1, toplo2, by = c('segment', 'osi')) |> 
  mutate(
    perc = acres.y / acres.x * 100,
  )
ggplot(toplo3, aes(x = perc, y = segment, fill = osi)) +
  geom_col( position = 'dodge', alpha = 0.85) +
  scale_fill_manual(values = c('darkblue', 'lightblue')) +
  guides(fill = guide_legend(reverse = T)) + 
  theme_minimal() +
  theme(
    legend.position = 'top',
    panel.grid.major.y = element_blank()
  ) + 
  labs(
    fill = 'Oyster Habitat Suitability Index', 
    x = '% of OHSI Category with Oyster Acres',
    y = NULL
  )
  
```

<br> 

The table below shows a tabular summary of current (2024) oyster coverage by OHSI category 14, 15, and neither.

```{r}
totab <- toplo2 |> 
  pivot_wider(
    names_from = 'osi', 
    values_from = 'acres', 
    values_fill = 0
  ) |> 
  mutate(
    Total = `14` + `15` + `Not 14 or 15`
  ) |> 
  select(segment, `14`, `15`, `Not 14 or 15`, Total)

reactable(totab, 
          columns = list(
            segment = colDef(name = 'Bay Segment', footer = 'Total'), 
            `14` = colDef(name = 'OHSI 14', footer = function(values) htmltools::tags$b(format(round(sum(values), 0), big.mark = ','))),
            `15` = colDef(name = 'OHSI 15', footer = function(values) htmltools::tags$b(format(round(sum(values), 0), big.mark = ','))), 
            `Not 14 or 15` = colDef(name = 'Not OHSI 14 or 15', footer = function(values) htmltools::tags$b(format(round(sum(values), 0), big.mark = ','))),
            Total = colDef(footer = function(values) htmltools::tags$b(format(round(sum(values), 0), big.mark = ',')))
          ),
          defaultColDef = colDef(
            format = colFormat(separators = TRUE, digits = 0), 
            footerStyle = list(fontWeight = 'bold')
          ),
          columnGroups = list(colGroup('Acres', columns = c('14', '15', 'Not 14 or 15', 'Total'))),
          defaultPageSize = nrow(totab),
          highlight = TRUE,
          striped = TRUE,
          bordered = TRUE,
          showPageSizeOptions = FALSE,
          showSortable = FALSE, 
          resizable = TRUE
  ) |> 
  add_title(
    "Oyster Coverage Total by bay segment and OHSI categories 14, 15, or neither", 
    font_size = 15, 
    font_color = 'grey', 
    font_weight = 'normal'
  )
```

## Option 2: Proportional to maximum oyster coverage

The second option estimates thresholds based on the proportion of maximum oyster coverage by bay segment, where the sum of the proportions is 471 acres.  This approach assumes that thresholds should be based on areas where oysters have been present or what is more easily attainable, rather than the OHSI categories.  Maximum oyster coverage was observed in 2022.

```{r}
totab <- oydat2022 |> 
  st_set_geometry(NULL) |> 
  summarise(
    acres = sum(acres, na.rm = TRUE),
    .by = c('segment')
  ) |> 
  mutate(
    segment = factor(segment, levels = levs),
    thrsh = goal * acres / sum(acres, na.rm = TRUE)
  ) |> 
  arrange(segment)

reactable(totab, 
          columns = list(
            segment = colDef(name = 'Bay Segment', footer = 'Total'), 
            acres = colDef(name = 'Max observed', footer = function(values) htmltools::tags$b(format(round(sum(values), 0), big.mark = ','))),
            thrsh = colDef(name = 'Threshold', footer = function(values) htmltools::tags$b(format(round(sum(values), 0), big.mark = ','))),
            Total = colDef(footer = function(values) htmltools::tags$b(format(round(sum(values), 0), big.mark = ',')))
          ),
          defaultColDef = colDef(
            format = colFormat(separators = TRUE, digits = 0), 
            footerStyle = list(fontWeight = 'bold')
          ),
          columnGroups = list(colGroup('Acres', columns = c('acres', 'thrsh'))),
          defaultPageSize = nrow(totab),
          highlight = TRUE,
          striped = TRUE,
          bordered = TRUE,
          showPageSizeOptions = FALSE,
          showSortable = FALSE, 
          resizable = TRUE
  ) |> 
  add_title(
    "Maximum observed oyster coverage (2022) and proportional threshold based on 471 acres", 
    font_size = 15, 
    font_color = 'grey', 
    font_weight = 'normal'
  )
```

<br>

Finally, the potential threshold based on maximum observed can be viewed relative to trends in oyster coverage over time.

```{r}
#| fig-cap: "Oyster Acres by Bay Segment with Threshold Proportional to Maximum Observed"
#| fig-width: 7
#| fig-height: 7

toploop2 <- oysdat |> 
  left_join(totab |> select(segment, thrsh), by = 'segment')

ggplot(toploop2, aes(x = yr, y = acres)) + 
  geom_col(alpha = 0.85, fill = '#00806E') + 
  facet_wrap(~segment, ncol = 3) +
  scale_x_continuous(breaks = c(2014, 2016, 2018, 2020, 2022, 2024)) +
  geom_hline(aes(yintercept = thrsh, linetype = 'Threshold'), color = 'tomato1', linewidth = 1) +
  scale_linetype_manual(name = NULL, values = 'dashed') +
  theme_minimal() +
  theme(
    legend.position = 'top',
    panel.grid.major.x = element_blank(),
    panel.grid.minor = element_blank()
  ) + 
  labs(
    x = NULL, 
    y = 'Oyster Acres'
  )
```

## Summary

Both options use different approaches to developing thresholds.  Option 1 prioritizes areas where oysters could be (high habitat suitability) regardless of current extent, whereas option 2 prioritizes areas where oysters have been regardless of priority habitat.  Each option has tradeoffs. 

* Option 1 may be more easily attained in some bay segments (e.g., Old Tampa Bay, Terra Ceia Bay) and more difficult in others (e.g., Hillsborough Bay, Manatee River).  

* For option 2, no bay segments are currently achieving the potential thresholds, whereas thresholds may be more easily achieved in some bay segments (e.g., Hillsborough Bay, Manatee River) and more difficult in others (e.g., Old Tampa Bay, Boca Ciega Bay).  

* Option 2 provides a more equitable distribution of thresholds across the bay segments, whereas option 1 provides lower priority to bay segments with higher oyster coverage compared to others.  

* Option 1 also provides two alternatives, one using both OHSI categories 14 and 15 or only category 15.  Differences in thresholds using either alternative vary by bay segment -- one alternative is not consistently higher or lower than the other.

* Option 2 is inclusive of the recommended 175 acres of restoration in Old Tampa Bay under the assimilative capacity project.

Using the current oyster coverage, the following table shows the necessary increase (or decrease if already attained) in oyster coverage to achieve potential thresholds under both options.

```{r}
totabfin <- inner_join(toploop1, toploop2, by = c('yr', 'segment', 'acres')) |> 
  filter(yr == 2024) |> 
  select(segment, acres, `14 and 15`, `15 only`, `Max observed` = thrsh) |>
  pivot_longer(
    cols = c("14 and 15", "15 only", "Max observed"),
    names_to = 'var',
    values_to = 'val'
  ) |>
  mutate(
    acrechg = val - acres,
    propchg = paste0('(', round(acrechg / acres, 2), ')'),
    acrechg = format(round(acrechg, 0), big.mark = ','),
  ) |> 
  select(-val) |> 
  unite('chg', acrechg, propchg, sep = ' ') |>
  pivot_wider(
    names_from = var,
    values_from = chg
  ) |> 
  arrange(segment)

reactable(totabfin, 
          columns = list(
            segment = colDef(name = 'Bay aegment'),
            acres = colDef(name = 'Current acres')
          ),
          defaultColDef = colDef(
            format = colFormat(separators = TRUE, digits = 0)
          ),
          columnGroups = list(
            colGroup('Option 1', columns = c('14 and 15', '15 only')), 
            colGroup('Option 2', columns = c('Max observed'))
            ),
          defaultPageSize = nrow(totabfin),
          highlight = TRUE,
          striped = TRUE,
          bordered = TRUE,
          showPageSizeOptions = FALSE,
          showSortable = FALSE, 
          resizable = TRUE
) |> 
  add_title(
    "Relative effort to achieve potential thresholds under both options.  Values shown are acres to go for each threshold, with the proportion of the current acres in parentheses (i.e., 1 = current acreage must double to achieve threshold). The total for the 'Current acres' column plus the total for any of the columns for option 1 or option 2 will equal 471 acres.", 
    font_size = 15, 
    font_color = 'grey', 
    font_weight = 'normal'
  )

```

